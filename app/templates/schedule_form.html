{% extends "base.html" %}

{% block title %}
    {% if action == "new" %}New Schedule{% else %}Edit Schedule{% endif %} - {{ app_name }}
{% endblock %}

{% block page_title %}
    {% if action == "new" %}üìÖ Create New Schedule{% else %}‚úèÔ∏è Edit Schedule{% endif %}
{% endblock %}

{% block page_description %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
        <p style="color: #6b7280; font-size: 18px; margin: 0;">
            {% if action == "new" %}
                Create automated message schedules for tenants.
            {% else %}
                Update schedule configuration and settings.
            {% endif %}
        </p>
        <a href="/schedules" class="btn btn-secondary">‚Üê Back to Schedules</a>
    </div>
{% endblock %}

{% block content %}
    <div class="card">
        <form method="post"
              action="{% if action == 'new' %}/schedules/new{% else %}/schedules/{{ schedule.id }}/edit{% endif %}"
              data-validate>

            <!-- Basic Information -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #1f2937;">
                    üìã Schedule Information
                </h2>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="name" class="form-label">Schedule Name *</label>
                        <input type="text"
                               id="name"
                               name="name"
                               class="form-input"
                               value="{% if schedule %}{{ schedule.name }}{% endif %}"
                               required
                               placeholder="Enter schedule name">
                        <div class="form-help">A descriptive name for this schedule</div>
                        <div class="form-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="schedule_type" class="form-label">Schedule Type *</label>
                        <select id="schedule_type"
                                name="schedule_type"
                                class="form-select"
                                required>
                            <option value="">Select type...</option>
                            <option value="rent_reminder" {% if schedule and schedule.schedule_type == 'rent_reminder' %}selected{% endif %}>Rent Reminder</option>
                            <option value="payment_due" {% if schedule and schedule.schedule_type == 'payment_due' %}selected{% endif %}>Payment Due</option>
                            <option value="late_fee" {% if schedule and schedule.schedule_type == 'late_fee' %}selected{% endif %}>Late Fee Notice</option>
                            <option value="general" {% if schedule and schedule.schedule_type == 'general' %}selected{% endif %}>General Message</option>
                        </select>
                        <div class="form-help">Type of automated message</div>
                        <div class="form-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description"
                              name="description"
                              class="form-textarea"
                              rows="3"
                              placeholder="Optional description of this schedule...">{% if schedule %}{{ schedule.description or '' }}{% endif %}</textarea>
                    <div class="form-help">Optional description of what this schedule does</div>
                    <div class="form-error"></div>
                </div>
            </div>

            <!-- Message Template -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #1f2937;">
                    üí¨ Message Template
                </h2>

                <div class="form-group">
                    <label for="message_template" class="form-label">Message Content *</label>
                    <textarea id="message_template"
                              name="message_template"
                              class="form-textarea"
                              rows="6"
                              required
                              placeholder="Enter the message template...">{% if schedule %}{{ schedule.message_template }}{% endif %}</textarea>
                    <div class="form-help">
                        Use placeholders: {tenant_name}, {rent_amount}, {due_date}, {building}
                    </div>
                    <div class="form-error"></div>
                </div>
            </div>

            <!-- Schedule Configuration -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #1f2937;">
                    ‚è∞ Schedule Configuration
                </h2>

                <div class="form-group">
                    <label for="schedule_frequency" class="form-label">Frequency *</label>
                    <select id="schedule_frequency"
                            name="schedule_frequency"
                            class="form-select"
                            required>
                        <option value="">Select frequency...</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="hourly">Hourly</option>
                    </select>
                    <div class="form-help">How often to run this schedule</div>
                    <div class="form-error"></div>
                </div>

                <!-- Time picker for non-hourly schedules -->
                <div id="schedule_time_picker" style="display: none;">
                    <div class="schedule-time-wrapper" style="margin-top: 24px;">
                        <div class="form-group">
                            <label class="form-label">‚è∞ Execution Time</label>

                            <!-- Time selection method toggle -->
                            <div class="time-method-toggle" style="display: flex; gap: 20px; margin-bottom: 20px; justify-content: center;">
                                <label class="radio-option" style="display: flex; align-items: center; gap: 8px; font-size: 16px; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s;">
                                    <input type="radio"
                                           name="schedule_time_method"
                                           value="preset"
                                           checked
                                           onchange="toggleScheduleTimeMethod('preset')"
                                           style="transform: scale(1.2);">
                                    <span>Common Times</span>
                                </label>
                                <label class="radio-option" style="display: flex; align-items: center; gap: 8px; font-size: 16px; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s;">
                                    <input type="radio"
                                           name="schedule_time_method"
                                           value="custom"
                                           onchange="toggleScheduleTimeMethod('custom')"
                                           style="transform: scale(1.2);">
                                    <span>Custom Time</span>
                                </label>
                            </div>

                            <!-- Preset time selection -->
                            <div id="schedule_preset_time" class="preset-time-options">
                                <div class="time-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <button type="button" class="time-option" onclick="selectScheduleTime(9, 0)" data-time="9:00"
                                            style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px 8px; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                        <span class="time" style="display: block; font-size: 18px; font-weight: 600; margin-bottom: 4px;">9:00 AM</span>
                                        <span class="desc" style="display: block; font-size: 14px; opacity: 0.8;">Morning</span>
                                    </button>
                                    <button type="button" class="time-option" onclick="selectScheduleTime(12, 0)" data-time="12:00"
                                            style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px 8px; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                        <span class="time" style="display: block; font-size: 18px; font-weight: 600; margin-bottom: 4px;">12:00 PM</span>
                                        <span class="desc" style="display: block; font-size: 14px; opacity: 0.8;">Noon</span>
                                    </button>
                                    <button type="button" class="time-option" onclick="selectScheduleTime(17, 0)" data-time="17:00"
                                            style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px 8px; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                        <span class="time" style="display: block; font-size: 18px; font-weight: 600; margin-bottom: 4px;">5:00 PM</span>
                                        <span class="desc" style="display: block; font-size: 14px; opacity: 0.8;">Evening</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Custom time selection -->
                            <div id="schedule_custom_time" class="custom-time-controls" style="display: none; margin-top: 16px;">
                                <div class="time-inputs" style="display: flex; gap: 16px; justify-content: center; align-items: start; flex-wrap: wrap;">
                                    <div class="hour-input" style="text-align: center;">
                                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">Hour</label>
                                        <select name="schedule_hour"
                                                id="schedule_hour"
                                                class="form-select time-select"
                                                style="width: 100px; text-align: center; font-size: 16px;">
                                            <option value="">--</option>
                                            {% for hour in range(0, 24) %}
                                                <option value="{{ hour }}"
                                                        {% if hour == 9 %}selected{% endif %}>
                                                    {{ "{:02d}".format(hour) }}
                                                    ({{ hour | format_12hour }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="minute-input" style="text-align: center;">
                                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">Minute</label>
                                        <select name="schedule_minute"
                                                id="schedule_minute"
                                                class="form-select time-select"
                                                style="width: 100px; text-align: center; font-size: 16px;">
                                            <option value="0" selected>00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected time display -->
                            <div class="selected-time-display" id="schedule_selected_time" style="margin-top: 16px; text-align: center;">
                                <div class="selected-time-badge" style="display: inline-flex; align-items: center; gap: 8px; background: #ecfdf5; border: 2px solid #10b981; border-radius: 12px; padding: 12px 20px; font-size: 18px; font-weight: 600; color: #047857;">
                                    <span class="time-icon" style="font-size: 20px;">‚è∞</span>
                                    <span class="selected-time-text">9:00 AM (Morning)</span>
                                </div>
                            </div>

                            <div class="form-help">Set the time when this schedule should run</div>
                            <div class="form-error"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Target Conditions -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #1f2937;">
                    üéØ Target Conditions
                </h2>

                <div class="form-group">
                    <label for="conditions_type" class="form-label">Send to *</label>
                    <select id="conditions_type"
                            name="conditions_type"
                            class="form-select"
                            required>
                        <option value="all_tenants">All Active Tenants</option>
                        <option value="unpaid_tenants">Tenants with Unpaid Rent</option>
                        <option value="late_fee_tenants">Tenants with Late Fees</option>
                        <option value="paid_tenants">Tenants with Paid Rent</option>
                    </select>
                    <div class="form-help">Which tenants should receive these messages</div>
                    <div class="form-error"></div>
                </div>

                {% if predefined_conditions %}
                    <div class="form-help" style="margin-top: 16px;">
                        <h4 style="margin-bottom: 8px;">Available Conditions:</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            {% for key, condition in predefined_conditions.items() %}
                                <li><strong>{{ key.replace('_', ' ').title() }}</strong>: {{ condition.description }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div style="display: flex; gap: 16px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <button type="submit" class="btn btn-primary btn-large">
                    {% if action == "new" %}
                        üìÖ Create Schedule
                    {% else %}
                        üíæ Update Schedule
                    {% endif %}
                </button>
                <a href="/schedules" class="btn btn-secondary btn-large">
                    Cancel
                </a>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Schedule Form JavaScript Functions

// Global variables for schedule time
let selectedScheduleHour = 9;
let selectedScheduleMinute = 0;

// Form validation and interaction
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[data-validate]');
    const frequencySelect = document.getElementById('schedule_frequency');
    const timePickerDiv = document.getElementById('schedule_time_picker');

    // Update time picker visibility based on frequency
    frequencySelect.addEventListener('change', function() {
        const frequency = this.value;

        if (frequency === 'hourly') {
            timePickerDiv.style.display = 'none';
        } else if (frequency) {
            timePickerDiv.style.display = 'block';
        } else {
            timePickerDiv.style.display = 'none';
        }
    });

    // Initialize schedule time selector
    initializeScheduleTimeSelector();
});

function initializeScheduleTimeSelector() {
    // Set initial selected time (9:00 AM is pre-selected)
    updateScheduleSelectedTimeDisplay();

    // Add event listeners for custom time inputs
    const hourSelect = document.getElementById('schedule_hour');
    const minuteSelect = document.getElementById('schedule_minute');

    if (hourSelect) {
        hourSelect.addEventListener('change', function() {
            if (this.value !== '') {
                selectedScheduleHour = parseInt(this.value);
                updateScheduleSelectedTimeDisplay();
            }
        });
    }

    if (minuteSelect) {
        minuteSelect.addEventListener('change', function() {
            selectedScheduleMinute = parseInt(this.value);
            updateScheduleSelectedTimeDisplay();
        });
    }
}

function toggleScheduleTimeMethod(method) {
    const presetDiv = document.getElementById('schedule_preset_time');
    const customDiv = document.getElementById('schedule_custom_time');

    if (method === 'preset') {
        presetDiv.style.display = 'block';
        customDiv.style.display = 'none';

        // Clear custom selections and set default
        document.getElementById('schedule_hour').value = '';
        document.getElementById('schedule_minute').value = '0';

        // Select 9:00 AM by default
        selectedScheduleHour = 9;
        selectedScheduleMinute = 0;
        selectScheduleTimeButton(9, 0);
    } else {
        presetDiv.style.display = 'none';
        customDiv.style.display = 'block';

        // Clear preset selections
        document.querySelectorAll('#schedule_preset_time .time-option').forEach(btn => {
            btn.classList.remove('selected');
            btn.style.borderColor = '#e5e7eb';
            btn.style.backgroundColor = 'white';
            btn.style.color = '';
        });

        // Set custom selects to current values
        document.getElementById('schedule_hour').value = selectedScheduleHour;
        document.getElementById('schedule_minute').value = selectedScheduleMinute;
    }

    updateScheduleSelectedTimeDisplay();
}

function selectScheduleTime(hour, minute) {
    selectedScheduleHour = hour;
    selectedScheduleMinute = minute;

    // Clear other selections
    document.querySelectorAll('#schedule_preset_time .time-option').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.borderColor = '#e5e7eb';
        btn.style.backgroundColor = 'white';
        btn.style.color = '';
    });

    // Select this time option
    selectScheduleTimeButton(hour, minute);
    updateScheduleSelectedTimeDisplay();
}

function selectScheduleTimeButton(hour, minute) {
    const timeStr = `${hour}:${minute.toString().padStart(2, '0')}`;
    const button = document.querySelector(`#schedule_preset_time .time-option[data-time="${timeStr}"]`);
    if (button) {
        button.classList.add('selected');
        button.style.borderColor = '#3b82f6';
        button.style.backgroundColor = '#3b82f6';
        button.style.color = 'white';
    }
}

function updateScheduleSelectedTimeDisplay() {
    const display = document.getElementById('schedule_selected_time');
    const badge = display.querySelector('.selected-time-badge');
    const text = badge.querySelector('.selected-time-text');

    if (selectedScheduleHour !== undefined && selectedScheduleHour !== '') {
        const time12h = formatScheduleTime12Hour(selectedScheduleHour, selectedScheduleMinute);
        const period = getTimePeriod(selectedScheduleHour);
        text.textContent = `${time12h} (${period})`;

        badge.style.background = '#ecfdf5';
        badge.style.borderColor = '#10b981';
        badge.style.color = '#047857';
    } else {
        text.textContent = 'No time selected';
        badge.style.background = '#f3f4f6';
        badge.style.borderColor = '#d1d5db';
        badge.style.color = '#6b7280';
    }
}

function formatScheduleTime12Hour(hour, minute) {
    const period = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
    const minuteStr = minute.toString().padStart(2, '0');
    return `${hour12}:${minuteStr} ${period}`;
}

function getTimePeriod(hour) {
    if (hour >= 5 && hour < 12) return 'Morning';
    else if (hour >= 12 && hour < 17) return 'Afternoon';
    else if (hour >= 17 && hour < 21) return 'Evening';
    else return 'Night';
}

// CSS for time option hover effects
const style = document.createElement('style');
style.textContent = `
    .time-option:hover {
        border-color: #3b82f6 !important;
        background-color: #eff6ff !important;
    }

    .radio-option:hover {
        background-color: #e5e7eb !important;
    }
`;
document.head.appendChild(style);

    // Form submission validation
    if (form) {
        form.addEventListener('submit', function(e) {
            const nameInput = document.getElementById('name');
            const scheduleTypeSelect = document.getElementById('schedule_type');
            const messageTemplateInput = document.getElementById('message_template');
            const frequencySelect = document.getElementById('schedule_frequency');

            let isValid = true;

            // Clear previous errors
            document.querySelectorAll('.form-error').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(el => el.classList.remove('error'));

            // Validate required fields
            if (!nameInput.value.trim()) {
                showError(nameInput, 'Schedule name is required');
                isValid = false;
            }

            if (!scheduleTypeSelect.value) {
                showError(scheduleTypeSelect, 'Schedule type is required');
                isValid = false;
            }

            if (!messageTemplateInput.value.trim()) {
                showError(messageTemplateInput, 'Message template is required');
                isValid = false;
            }

            if (!frequencySelect.value) {
                showError(frequencySelect, 'Schedule frequency is required');
                isValid = false;
            }

            // Validate time inputs
            const hour = parseInt(hourInput.value);
            const minute = parseInt(minuteInput.value);

            if (frequencySelect.value !== 'hourly') {
                if (isNaN(hour) || hour < 0 || hour > 23) {
                    showError(hourInput, 'Hour must be between 0 and 23');
                    isValid = false;
                }

                if (isNaN(minute) || minute < 0 || minute > 59) {
                    showError(minuteInput, 'Minute must be between 0 and 59');
                    isValid = false;
                }
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    }

    function showError(input, message) {
        input.classList.add('error');
        const errorDiv = input.parentNode.querySelector('.form-error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.color = '#dc2626';
        }
    }

    // Trigger initial frequency change
    frequencySelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}
