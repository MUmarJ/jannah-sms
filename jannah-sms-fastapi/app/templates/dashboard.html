{% extends "base.html" %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block page_title %}📊 Dashboard{% endblock %}

{% block page_description %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
        <p style="color: #6b7280; font-size: 18px; margin: 0;">
            Welcome to your SMS management system. Here's an overview of your activity.
        </p>
        
        <!-- SMS Quota Display -->
        {% if sms_quota is not none %}
            <div style="background-color: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px 16px; text-align: center;">
                <div style="font-size: 14px; color: #0369a1; margin-bottom: 4px; font-weight: 500;">SMS Credits Remaining</div>
                <div style="font-size: 24px; font-weight: 700; color: #0c4a6e;">{{ sms_quota }}</div>
                <div style="font-size: 12px; color: #0369a1; margin-top: 2px;">(Test Mode)</div>
            </div>
        {% else %}
            <div style="background-color: #fef2f2; border: 1px solid #f87171; border-radius: 8px; padding: 12px 16px; text-align: center;">
                <div style="font-size: 14px; color: #dc2626; margin-bottom: 4px; font-weight: 500;">SMS Status</div>
                <div style="font-size: 16px; font-weight: 600; color: #991b1b;">Unable to check quota</div>
                <div style="font-size: 12px; color: #dc2626; margin-top: 2px;">Check API configuration</div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
    <!-- Quick Stats Grid -->
    <div class="grid grid-4" style="margin-bottom: 32px;">
        <div class="card">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">👥</div>
                <h3 style="margin: 0; font-size: 32px; color: #2563eb;">{{ stats.total_tenants or 0 }}</h3>
                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 18px;">Total Tenants</p>
            </div>
        </div>

        <div class="card">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">⏰</div>
                <h3 style="margin: 0; font-size: 32px; color: #059669;">{{ stats.active_schedules or 0 }}</h3>
                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 18px;">Active Schedules</p>
            </div>
        </div>

        <div class="card">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">📱</div>
                <h3 style="margin: 0; font-size: 32px; color: #d97706;">{{ stats.messages_today or 0 }}</h3>
                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 18px;">Messages Today</p>
            </div>
        </div>

        <div class="card">
            <div style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">✅</div>
                <h3 style="margin: 0; font-size: 32px; color: #dc2626;">{{ stats.success_rate or 0 }}%</h3>
                <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 18px;">Success Rate</p>
            </div>
        </div>
    </div>

    <!-- Main Actions -->
    <div class="card" style="margin-bottom: 32px;">
        <h2 style="margin-bottom: 24px;">🚀 Quick Actions</h2>
        <div class="grid grid-2">
            <a href="/messages/send" class="btn btn-primary btn-large" style="text-decoration: none;">
                📤 Send Message Now
            </a>
            <a href="/schedules/new" class="btn btn-secondary btn-large" style="text-decoration: none;">
                ⏰ Create New Schedule
            </a>
            <a href="/tenants/import" class="btn btn-secondary btn-large" style="text-decoration: none;">
                📋 Import Tenants
            </a>
            <a href="/messages/history" class="btn btn-secondary btn-large" style="text-decoration: none;">
                📊 View Message History
            </a>
        </div>
    </div>

    <!-- Two Column Layout for Recent Activity and Upcoming Schedules -->
    <div class="grid grid-2">
        <!-- Recent Messages -->
        <div class="card">
            <h2 style="margin-bottom: 24px;">📬 Recent Messages</h2>
            
            {% if recent_messages %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tenant</th>
                                <th>Status</th>
                                <th>Sent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for message in recent_messages %}
                                <tr>
                                    <td>{{ message.tenant_name }}</td>
                                    <td>
                                        <span class="status-badge 
                                            {% if message.status == 'sent' %}status-active
                                            {% elif message.status == 'failed' %}status-error
                                            {% else %}status-paused{% endif %}">
                                            {{ message.status_display }}
                                        </span>
                                    </td>
                                    <td>{{ message.sent_at | format_datetime }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <a href="/messages/history" class="btn btn-secondary">View All Messages</a>
                </div>
            {% else %}
                <div style="text-align: center; padding: 48px; color: #6b7280;">
                    <div style="font-size: 64px; margin-bottom: 16px;">📭</div>
                    <p style="font-size: 18px; margin: 0;">No messages sent yet</p>
                    <a href="/messages/send" class="btn btn-primary" style="margin-top: 16px;">Send Your First Message</a>
                </div>
            {% endif %}
        </div>

        <!-- Upcoming Schedules -->
        <div class="card">
            <h2 style="margin-bottom: 24px;">⏰ Upcoming Schedules</h2>
            
            {% if upcoming_schedules %}
                {% for schedule in upcoming_schedules %}
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 18px;">{{ schedule.name }}</h3>
                            <span class="status-badge status-active">{{ schedule.status_display }}</span>
                        </div>
                        <p style="margin: 0 0 8px 0; color: #6b7280;">{{ schedule.schedule_display }}</p>
                        {% if schedule.next_run %}
                            <p style="margin: 0; font-size: 16px; color: #374151;">
                                <strong>Next run:</strong> {{ schedule.next_run | format_datetime }}
                            </p>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <div style="text-align: center; margin-top: 16px;">
                    <a href="/schedules" class="btn btn-secondary">Manage All Schedules</a>
                </div>
            {% else %}
                <div style="text-align: center; padding: 48px; color: #6b7280;">
                    <div style="font-size: 64px; margin-bottom: 16px;">⏰</div>
                    <p style="font-size: 18px; margin: 0;">No schedules created yet</p>
                    <a href="/schedules/new" class="btn btn-primary" style="margin-top: 16px;">Create Your First Schedule</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- System Status (if needed) -->
    {% if system_status %}
        <div class="card" style="margin-top: 32px;">
            <h2 style="margin-bottom: 16px;">🔧 System Status</h2>
            <div class="grid grid-3">
                <div style="text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        {% if system_status.sms_api %}✅{% else %}❌{% endif %}
                    </div>
                    <p style="margin: 0; font-weight: 600;">SMS API</p>
                    <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 16px;">
                        {% if system_status.sms_api %}Connected{% else %}Disconnected{% endif %}
                    </p>
                </div>

                <div style="text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        {% if system_status.scheduler %}✅{% else %}❌{% endif %}
                    </div>
                    <p style="margin: 0; font-weight: 600;">Scheduler</p>
                    <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 16px;">
                        {% if system_status.scheduler %}Running{% else %}Stopped{% endif %}
                    </p>
                </div>

                <div style="text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        {% if system_status.database %}✅{% else %}❌{% endif %}
                    </div>
                    <p style="margin: 0; font-weight: 600;">Database</p>
                    <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 16px;">
                        {% if system_status.database %}Connected{% else %}Error{% endif %}
                    </p>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh dashboard data every 30 seconds
    let refreshInterval;
    
    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            // Only refresh if the page is visible
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, 30000); // 30 seconds
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    }
    
    // Start auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', startAutoRefresh);
    
    // Stop auto-refresh when page is not visible
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
    
    // Stop auto-refresh when leaving the page
    window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}