version: '3.8'

services:
  jannah-sms:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jannah-sms-app
    ports:
      - "8000:8000"
    volumes:
      # Persist database and logs
      - ./:/app
      - ./logs:/app/logs
      # Configuration override
      - ./.env:/app/.env:ro
    environment:
      # Core settings
      - DATABASE_URL=sqlite:///./jannah_sms.db
      - DEBUG=false
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}

      # Company settings
      - COMPANY_NAME=${COMPANY_NAME:-Jannah Property Management}
      - APP_NAME=${APP_NAME:-Jannah SMS Admin}

      # SMS API settings (from .env file)
      - SMS_API_KEY=${SMS_API_KEY}
      - SMS_API_BASE=https://textbelt.com/text

      # Security settings
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=60
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}

      # Elderly-friendly UI settings
      - UI_LARGE_FONTS=true
      - UI_HIGH_CONTRAST=true
      - UI_SIMPLE_NAVIGATION=true

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jannah-sms.rule=Host(`sms.yourdomain.com`)"
      - "traefik.http.routers.jannah-sms.tls=true"
      - "traefik.http.routers.jannah-sms.tls.certresolver=letsencrypt"

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: jannah-sms-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - jannah-sms
    restart: unless-stopped
    profiles:
      - production

  # Optional: Database backup service
  db-backup:
    image: alpine:latest
    container_name: jannah-sms-backup
    volumes:
      - ./:/app:ro
      - ./backups:/app/backups
    command: >
      sh -c "
        while true; do
          echo 'Creating database backup...'
          cp /app/jannah_sms.db /app/backups/jannah_sms_$(date +%Y%m%d_%H%M%S).db
          find /app/backups -name '*.db' -mtime +7 -delete
          echo 'Backup completed. Sleeping for 24 hours...'
          sleep 86400
        done
      "
    restart: unless-stopped
    profiles:
      - production

volumes:
  data:
  logs:
  backups:
